# XP extension for Visual Studio Code

VSCode XP - это расширение для [VsCode](https://code.visualstudio.com/) и [VsCodium](https://vscodium.com/) для просмотра, создания, редактирования и тестирования правил на языке [XP (eXtraction and Processing)](https://help.ptsecurity.com/projects/siem/7.2/ru-RU/help/1566366731). При помощи данного расширения можно разрабатывать экспертизу для всех продуктов, которые поддерживают синтаксис языка XP:
  - [SOLDR](https://github.com/vxcontrol/soldr) 
  - [MaxPatrol SIEM](https://help.ptsecurity.com/projects/siem/7.2/ru-RU/help/709049099)
  - [PT XDR](https://help.ptsecurity.com/projects/xdr/3.2/ru-RU/help/3336136843)

Расширение обеспечивает [базовый функционал](#basic-and-full-functionality) на операционных системах Windows, Linux и MacOS и [полный функционал](#basic-and-full-functionality) - на Windows.

[Тут](https://github.com/Security-Experts-Community/vscode-xp/releases) можно скачать расширение в виде скомпилированного пакета. В дальшейшем планируем разместить расширение в [магазине расширений для VsCode](https://code.visualstudio.com/docs/editor/extension-marketplace).

Разработка проекта осуществляется в рамках открытого сообщества [Security Experts Community](https://github.com/Security-Experts-Community), вы можете внести [свой вклад](#for-developers) в развитие проекта.

Если возникают вопросы, то можно обращаться в [этот](https://t.me/MPSIEMChat) чат.

## Project repositories

Основной:
- GitHub: https://github.com/Security-Experts-Community/vscode-xp

Зеркала:
- Codeberg: https://codeberg.org/Security-Experts-Community/vscode-xp
- GitFlic: https://gitflic.ru/project/security-experts-community/vscode-xp

## Table of Contents

- [базовый и полный функционал](#basic-and-full-functionality);
- [типичные сценарии использования](#typical-use-cases);
- [настройка утилит для получения полного функционала](#configuring-tools).

## Basic and full functionality

Весь функционал расширения можно разделить на базовый и полный. Данное разделение возникло из-за того, что для использования всех функций необходимо скачать пакет утилит для работы с языком XP. После скачивания и установки расширения пользователю доступен только базовый функционал, а полный требует [настройки дополнительных утилит](#configuring-tools).

Под базовым функционалом расширения будем понимать следующий список функций:

- просмотр и редактирования нормализаций, агрегаций, корреляций, обогащений и табличных списков;
- автоматическое дополнение ключевых слов, функция языка, полей таксономии, типовых конструкций языка;
- статическое валидирование кода на типовые ошибки вайтлистинга (alert.key и макросы, имя правила и макросы);
- cоздание корреляции и обогащений через готовые шаблоны в зависимости от основных событий для детекта;
- просмотр, редактирование метаинформации нормализаций, корреляций, обогащений через контекстное меню;
- просмотр, редактирование локализаций нормализаций, корреляций через контекстное меню;
- просмотр, редактирование и создание интеграционных тестов для корреляций и обогащений;
- просмотр, редактирование и создание модульных тестов для корреляций и обогащений.

Полный функционал подразумевает базовый функционал и:

- запуск интеграционных, быстрых и модульных тестов для корреляций и обогащений;
- сборку графов нормализаций, табличных список;
- прогон сырых событий по всему графу корреляций;
- распаковка и упаковка пакетов экпертизы формата kb для последующего импорта.

## Typical use cases

В данном разделе представлены типичные кейсы по использованию расширения в разработке контента.

### Refinement of existing content

В этом случае предполагается, что в продукте уже имеется контент, который требует доработки. Для реализации данного сценария необходимо указать путь к утилите `kbtools` в расширении.

1. Экспортировать контент из MaxPatrol SIEM можно [следующим образом](https://help.ptsecurity.com/projects/siem/7.2/ru-RU/help/3320343819). Для работы сразу со всем контентом нужно экспортировать его полностью из продукта (TODO: дать более точные указания).
2. Далее в окне расширения на панели `Дерево контента` нужно нажать кнопку `Экспорт kb-файла`(TODO) и выбрать экспортированный файл и директорию для его распаковки.
3. После распаковки в дереве отобразиться штатная структура контента. Все правила хранятся в виде пакетов в поддиректории `packages`. Для сохранения изменений рекомендуется использовать систему контроля версии, например, git.
4. После доработки контента нажимаем на кнопку `Импорт kb-файла`(TODO) и выбираем путь к сохраняемого kb-файлу.
5. Для импорта kb-файла используем [данную инструкцию](https://help.ptsecurity.com/projects/siem/7.2/ru-RU/help/2061363851).

### Доработка существующего контента с тестированием

В этом случае предполагается, что в продукте уже имеется контент, который требует доработки. Для реализации данного сценария необходимо указать путь к утилите `kbtools.exe`, утилитам `siem-sdk` и `build-tools` в расширении. Порядок работы с контентом аналогичен работе [без тестов](#refinement-of-existing-content) за исключением использования [тестов](#tests) для проверки работоспособности правила.

### Создание структуры контента с нуля для замещения имеющегося в продукте

1. В окне расширения на панели `Дерево контента` нужно нажать кнопку `Создать базу знаний` (TODO) и директорию для её размещения.
2. После чего создается пустое дерево контента дя создания контента с нуля. **TODO** тут нужны: файл таксономии, tables_contract.yaml, макросы.

### Разработка правил с нуля без тестов

Наимение удобный способ использования расширения. В этом случае будет достаточно просто установить расширение на VsCode или VsCodium и приступать к [работе с контентом](#content-management).

## Content management

### Создание правила

1. Нажимаем на иконку расширения (Редактор контента).
2. На нужной директории в дереве контента вызываем контекстное меню.
3. В зависимости от типа создаваемого контента: `Cоздать корреляцию`, `Cоздать обогащение`.
4. Далее необходимо ввести название создаваемого правила и выбрать подходящий шаблон. Шаблон выбирается на основании предполагаемого основного события для детекта.
5. В зависимости от выбранного типа контента и шаблона у вас открывается файл для написания кода правила.

### Tests

После создания проекта правила, можно добавить интеграционные тесты.

### Прогон сырых событый по всему графу корреляций

Если у вас есть выборка сырых событий, то в расширении можно проверить какие корреляции из открытых отработают при попадании подобных событий в продукт.

## Configuring tools

Если у вас уже развернут Maxpatrol SIEM, тогда набор необходимых утилит можно найти по путям `C:\ProgramData\Positive Technologies\Knowledge Base\SiemSdks` и `C:\Program Files\Positive Technologies\Knowledge Base\Tools`. Их необходимо скопировать на компьютер с запущенным расширением и в настройках задать путь к данным утилитам.

## For developers

Если вы разработчик и желаете внести в свой вклад в разработку расширения, то ниже представлена информация для вас. У нас есть [беклог](#backlog), по которому планируется вести разработку.

### Build from sources

Для компиляции исходников необходимо:

1. Установить [VsCode](https://code.visualstudio.com/).
2. Установить [node.js](https://nodejs.org/en/download/).
3. Выгрузить код из рапозитория (`git clone`).
4. Выполнить команду `npm install` в корне проекта.

Для publish-а расширения нужно:

1. Единожды выполнить команду `npm install -g vsce`.
2. При каждом паблише запускать publish.py из корня проекта или выполнять команду `vsce package -o xpContentEditor.vsix`.

## Backlog

### Content Tree

1. Добавить возможность переименования директории в дереве контента.

### Код правил

- Автодополнение локальных переменных, например, `$auto_profile`.
- Разделить автодополнение функций по типам контента (нормализация, обогащение и корреляция).
- Автодополнение имен табличных списков из открытой базы знаний.
- Автодополнение макросов из файлов *.flt. Сейчас в сниппеты добавлен статический список.
- Проверка наличия метки используемой функции вайтлистинга, например, `CheckWL_Specific_Only` и т.д.

### Локализации

- Автоматическая проверка наличия недопустимых для локализации полей, например, object.process.fullpath, subject.process.fullpath, object.process.hash, subject.account.id.
- Сравнение множества используемых полей английской и русской локализации и вывод ошибки если они отличаются. Это является свидетельством отличия русской и английской локализаций.

### WebView

- Перевести WebView на один из известных фреймворков (Vue.js, React и т.д.).
- Блокировать кнопки при выполнение операций.
- Предлагать пользователю сохранить данные из WebView при открытии новой если они были изменены.
- Обновление вьюшек при переключении ветки. Например, у тебя открыты модульные тесты правила. Ты сделал pull и тесты обновились, но у тебя открыты старые.
- Поддерживать все возможные статусы интеграционных тестов.

### Корректность кода (тестов, локализаций, метаинформации и т.д.)

- Добавить проверку корректности задания ключах вайтлистинга.
- Выявление ошибок неявной конвертации типизированных полей, например, ip-адреса (src.ip, event_src.ip и т.д.) к строке, результатом которого является пустая строка ("").
- MITRE в метаинформации совпадают с полями `category.*` правила.
- Для сабрулей задана `$importance = "info"`, нет полей incident.* и задан тип `$correlation_type = "subrule"`.
- Если используются события 4103/4104, убедиться что фильтр содержит `object == "command" and action == "execute"`.
- Проверять перезапись полей секций on в понятных сценариях, например, `eventA and eventB and EventC`.
- В секции on или директиве rule определено событие, для которого нет директивы event.
- Статические проверки правильности формата модульных и интеграционных тестов:
  - валидный json;
  - валидное заполнение ТС;
  - table_list;
  - правильно задан expect[один пробел]1 {...}.
